@startuml
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Container.puml

LAYOUT_WITH_LEGEND()

title Component Overview - Edge Certificate Agent (ECA) PoC System

Person(operator, "Operator/Developer", "Interacts with system for testing and monitoring")

System_Boundary(eca_system, "Edge Certificate Agent PoC System") {

  Container(eca_acme_agent, "ECA-ACME Agent", "PowerShell Core 7.4", "Autonomous agent: monitors server cert expiry, executes ACME protocol, installs certificates, triggers NGINX reload")

  Container(eca_est_agent, "ECA-EST Agent", "PowerShell Core 7.4", "Autonomous agent: monitors client cert expiry, executes EST enrollment/re-enrollment, installs client certificates")

  Container(target_server, "Target Server", "NGINX 1.25", "Web server serving HTTPS using server certificates. Supports mTLS client authentication")

  Container(target_client, "Target Client", "Alpine + curl + OpenSSL", "Simulated client device using client certificate for mTLS authentication")

  Container(pki, "PKI Authority", "Smallstep step-ca 0.25", "Certificate Authority with ACME provisioner (server certs) and EST provisioner (client certs)")

  Container(web_ui, "Web Dashboard", "Node.js/Express", "Real-time certificate status visualization and manual renewal triggers (Optional)")

  ContainerDb(volume_server_certs, "Server Certs Volume", "Docker Volume", "Shared storage: /certs/server - Contains server private key and certificate")

  ContainerDb(volume_client_certs, "Client Certs Volume", "Docker Volume", "Shared storage: /certs/client - Contains client private key and certificate")
}

' Operator interactions
Rel(operator, web_ui, "Views cert status, triggers renewals", "HTTPS (Port 8080)")
Rel(operator, eca_acme_agent, "Views logs", "Docker logs")
Rel(operator, eca_est_agent, "Views logs", "Docker logs")

' ACME Agent interactions
Rel(eca_acme_agent, pki, "ACME protocol flow", "HTTPS/JSON (Port 9000)")
Rel(eca_acme_agent, volume_server_certs, "Writes cert & private key", "File I/O (atomic)")
Rel(eca_acme_agent, target_server, "Triggers reload", "Docker exec: nginx -s reload")

' EST Agent interactions
Rel(eca_est_agent, pki, "EST protocol flow", "HTTPS (Port 9000)")
Rel(eca_est_agent, volume_client_certs, "Writes cert & private key", "File I/O (atomic)")

' Target Server interactions
Rel(target_server, volume_server_certs, "Reads cert & key on startup/reload", "File I/O")

' Target Client interactions
Rel(target_client, volume_client_certs, "Reads cert & key", "File I/O")
Rel(target_client, target_server, "mTLS authentication", "HTTPS with client certificate")

' Web UI interactions
Rel(web_ui, volume_server_certs, "Reads cert metadata", "File I/O (read-only)")
Rel(web_ui, volume_client_certs, "Reads cert metadata", "File I/O (read-only)")
Rel(web_ui, eca_acme_agent, "Triggers renewal", "Trigger file / HTTP API")
Rel(web_ui, eca_est_agent, "Triggers renewal", "Trigger file / HTTP API")

@enduml
