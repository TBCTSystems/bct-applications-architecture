# Mosquitto configuration for Enterprise Certificate Management PoC
# This configuration enforces mTLS for all client connections

# =============================================================================
# Network Configuration
# =============================================================================

# MQTT over TLS port
listener 8883
protocol mqtt

# Disable non-TLS listeners for security
# listener 1883 is intentionally disabled

# =============================================================================
# TLS/SSL Configuration
# =============================================================================

# Server certificate and key (issued by step-ca)
certfile /mosquitto/certs/mosquitto.crt
keyfile /mosquitto/certs/mosquitto.key

# Root CA certificate for validating client certificates
cafile /mosquitto/certs/root_ca.crt

# Require client certificates (mTLS)
require_certificate true

# Use the certificate CN as the username
use_identity_as_username true

# Verify client certificates against CA
tls_version tlsv1.2

# =============================================================================
# Security Configuration
# =============================================================================

# Disable anonymous access
allow_anonymous false

# Client certificate verification
verify_certificate true

# =============================================================================
# Access Control
# =============================================================================

# Topic-based access control using certificate identity
# This will be enhanced with ACL files for production

# Default permissions for authenticated clients
# Clients can publish/subscribe to topics based on their certificate CN

# =============================================================================
# Logging Configuration
# =============================================================================

# Log destinations
log_dest file /mosquitto/log/mosquitto.log
log_dest stdout

# Log types
log_type error
log_type warning
log_type notice
log_type information

# Connection logging for security monitoring
connection_messages true

# =============================================================================
# Performance and Reliability
# =============================================================================

# Maximum concurrent connections
max_connections 1000

# Message size limits
message_size_limit 268435456

# Persistence
persistence true
persistence_location /mosquitto/data/

# Automatic save interval
autosave_interval 1800

# =============================================================================
# WebSocket Configuration (Optional)
# =============================================================================

# WebSocket over TLS for web clients
listener 9001
protocol websockets
certfile /mosquitto/certs/mosquitto.crt
keyfile /mosquitto/certs/mosquitto.key
cafile /mosquitto/certs/root_ca.crt
require_certificate true
use_identity_as_username true