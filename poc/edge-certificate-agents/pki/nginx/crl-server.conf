# ==============================================================================
# CRL HTTP Server Configuration - nginx
# ==============================================================================
# Lightweight HTTP server for distributing Certificate Revocation Lists (CRLs)
# Runs unprivileged on port 9001 as the 'step' user
# ==============================================================================

worker_processes  1;
error_log  /home/step/nginx-crl/logs/error.log;
pid        /home/step/nginx-crl/nginx.pid;

events {
    worker_connections  1024;
}

http {
    access_log  /home/step/nginx-crl/logs/access.log;
    sendfile    on;
    tcp_nopush  on;

    # Temporary directories for nginx operations
    client_body_temp_path /home/step/nginx-crl/temp/client_body;
    proxy_temp_path       /home/step/nginx-crl/temp/proxy;
    fastcgi_temp_path     /home/step/nginx-crl/temp/fastcgi;
    uwsgi_temp_path       /home/step/nginx-crl/temp/uwsgi;
    scgi_temp_path        /home/step/nginx-crl/temp/scgi;

    server {
        # Listen on port 9001 (CRL distribution port)
        listen       9001;
        listen       [::]:9001;
        server_name  _;

        # Prevent caching of CRL files (always fetch fresh copy)
        add_header Cache-Control "no-cache";

        # Redirect /crl to /crl/ for consistency
        location = /crl {
            return 301 /crl/;
        }

        # Serve CRL files from /home/step/crl directory
        location /crl/ {
            alias /home/step/crl/;
            autoindex off;

            # Set correct MIME type for CRL files
            types {
                application/pkix-crl crl;
            }
            default_type application/octet-stream;

            # Try to serve the requested file, return 404 if not found
            try_files $uri $uri/ =404;
        }

        # Health check endpoint for monitoring
        location /health {
            access_log off;
            return 200 "CRL server healthy\n";
            add_header Content-Type text/plain;
        }
    }
}
