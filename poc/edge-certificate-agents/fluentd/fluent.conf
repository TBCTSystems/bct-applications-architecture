# ============================================
# FluentD Configuration for ECA PoC
# Backend: Grafana Loki
# ============================================

# ============================================
# INPUT: Collect logs from Docker containers
# ============================================

# FluentD forward protocol (for Docker logging driver)
<source>
  @type forward
  port 24224
  bind 0.0.0.0
</source>

# ============================================
# FILTER: Parse and enrich logs
# ============================================

# Parse JSON log format from ECA agents
<filter docker.**>
  @type parser
  key_name log
  reserve_data true
  remove_key_name_field true  # Remove the original 'log' field after parsing
  <parse>
    @type json
    time_key timestamp
    time_format %Y-%m-%dT%H:%M:%SZ
  </parse>
  # Suppress parse errors for non-JSON logs (NGINX, etc.)
  emit_invalid_record_to_error false
</filter>

# Add container metadata and extract agent information
<filter docker.**>
  @type record_modifier
  <record>
    # Extract agent type from container name
    agent_type ${record.dig("container_name").to_s.include?("acme") ? "acme" : record.dig("container_name").to_s.include?("est") ? "est" : "other"}
    environment "eca-poc"
    log_source "docker"
  </record>
</filter>

# Extract operation and status from nested context for Loki labels
<filter docker.**>
  @type record_transformer
  enable_ruby true
  <record>
    operation ${record["context"].is_a?(Hash) && record["context"]["operation"] ? record["context"]["operation"] : "unknown"}
    status ${record["context"].is_a?(Hash) && record["context"]["status"] ? record["context"]["status"] : "unknown"}
  </record>
</filter>

# Tag-based routing for different log types
<match docker.**>
  @type rewrite_tag_filter

  # Route ERROR severity logs
  <rule>
    key severity
    pattern /^ERROR$/
    tag eca.error.${tag}
  </rule>

  # Route operation logs (renewal, enrollment, check)
  <rule>
    key message
    pattern /(renewal|enrollment|check) operation/
    tag eca.operation.${tag}
  </rule>

  # Route all other logs
  <rule>
    key message
    pattern /.*/
    tag eca.general.${tag}
  </rule>
</match>

# ============================================
# OUTPUT: Send to Grafana Loki
# ============================================

# Send ALL logs to Loki with labels
<match eca.**>
  @type loki
  url http://loki:3100
  tenant fluent-bit

  # Extract labels from log fields (indexed for fast queries)
  # Keep labels low-cardinality for performance
  # operation: ~30 unique values (certificate_check, crl_parse, etc.)
  # status: ~28 unique values (success, failed, pending, etc.)
  <label>
    agent_type
    severity
    environment
    operation
    status
  </label>

  # Additional labels from context (optional)
  extra_labels {"job":"eca-agents"}

  # Don't remove keys - keep full record for JSON parsing in Grafana
  # The dashboards use | json to parse fields from the log line

  # Line format: Output the entire record as a single JSON string
  # This allows Grafana to use | json to parse fields
  line_format json

  # Buffer configuration for reliability
  <buffer>
    @type file
    path /var/log/fluentd/buffer/loki
    flush_interval 5s
    flush_at_shutdown true
    retry_wait 5s
    retry_max_interval 30s
    retry_forever false
    retry_max_times 5
    chunk_limit_size 1m
  </buffer>
</match>

# ============================================
# MONITORING: FluentD metrics endpoint
# ============================================

<source>
  @type monitor_agent
  bind 0.0.0.0
  port 24220
</source>
